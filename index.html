<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Egg Clicker Mini App</title>
    <style>
        /* --- RESET & BASE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background: #111; }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
        }

        /* --- LAYOUT --- */
        #app-container { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Top Bar */
        .top-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 50;
            flex-shrink: 0;
            height: 50px;
        }

        .logo { font-size: 14px; font-weight: 700; opacity: 0.9; }
        .balance-display { display: flex; gap: 12px; font-size: 12px; font-weight: 600; }

        /* Main Content Area */
        .content {
            flex: 1;
            overflow-y: auto; /* Scrollable area */
            position: relative;
            scroll-behavior: smooth;
            padding-bottom: 80px; /* Space for nav */
        }

        /* Screens */
        .screen {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENTS --- */
        
        /* Egg Card */
        .egg-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .egg-name { font-size: 20px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .egg-description { font-size: 13px; opacity: 0.7; margin-bottom: 15px; line-height: 1.4; min-height: 40px; }

        .egg-container { position: relative; display: inline-block; margin: 10px auto; }
        .egg-glow {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 220px; height: 220px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            border-radius: 50%; pointer-events: none;
        }
        
        .egg-image {
            width: 200px; height: 200px;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.05s;
            user-select: none;
            position: relative; z-index: 2;
        }
        .egg-image:active { transform: scale(0.95); }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%; height: 26px;
            background: rgba(0,0,0,0.3);
            border-radius: 13px;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d68f 0%, #00b8a9 100%);
            width: 0%;
            transition: width 0.2s ease-out;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .progress-text { font-size: 12px; margin-top: 5px; opacity: 0.8; }

        /* Collection Box */
        .collection-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px; border-radius: 18px;
            text-align: center; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .collection-label { font-size: 12px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }
        .collection-amount { font-size: 28px; font-weight: 800; margin: 10px 0; color: #ffd700; }
        .collect-btn {
            background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            border: none; color: white;
            padding: 12px 30px; border-radius: 50px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4);
            transition: transform 0.1s;
        }
        .collect-btn:active { transform: scale(0.95); }
        .collect-btn:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }
        .next-collection { font-size: 11px; opacity: 0.5; margin-top: 8px; }

        /* Grids */
        .creatures-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
        }
        .creature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 15px;
            text-align: center; position: relative;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .creature-card:not(.locked):hover { background: rgba(255, 255, 255, 0.15); border-color: rgba(255,255,255,0.2); }
        .creature-card.locked { opacity: 0.5; filter: grayscale(0.8); }
        
        .creature-image { width: 70px; height: 70px; object-fit: contain; margin-bottom: 8px; }
        .c-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .c-level { font-size: 11px; opacity: 0.7; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; display: inline-block; }
        .c-income { font-size: 12px; color: #00d68f; margin-top: 5px; font-weight: 600; }

        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .action-btn {
            background: rgba(255, 255, 255, 0.1); border: none; color: white;
            padding: 12px 5px; border-radius: 12px; font-size: 20px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .action-label { font-size: 10px; font-weight: bold; opacity: 0.7; }

        /* Bottom Nav */
        :root { --bottom-nav-h: 70px; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-h);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(15px);
            display: flex; justify-content: space-around;
            align-items: center; z-index: 100;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .nav-btn {
            background: none; border: none; color: rgba(255,255,255,0.5);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 20px; cursor: pointer; padding: 10px; transition: color 0.2s;
        }
        .nav-btn.active { color: #fff; }
        .nav-label { font-size: 10px; font-weight: 600; }

        /* Detail Overlay */
        .detail-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 200; display: none; flex-direction: column;
            padding-bottom: var(--bottom-nav-h);
        }
        .detail-screen.active { display: flex; animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .detail-header {
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2);
        }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .detail-content { flex: 1; overflow-y: auto; padding: 20px; }
        .upgrade-section { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; margin-top: 20px; }
        .upgrade-btn { width: 100%; background: #00d68f; border: none; color: #004d40; padding: 14px; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 15px; cursor: pointer; }
        .upgrade-btn:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* Hatch Overlay */
        .hatch-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92); z-index: 300;
            display: none; align-items: center; justify-content: center;
            flex-direction: column; padding: 20px; text-align: center;
        }
        .hatch-overlay.active { display: flex; animation: fadeIn 0.5s; }
        
        .hatch-creature-reveal { width: 200px; height: 200px; object-fit: contain; animation: bounceIn 1s; margin: 20px auto; }
        @keyframes bounceIn { 0% { transform: scale(0); } 60% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- EFFECTS & UTILS --- */
        .float-text {
            position: fixed; pointer-events: none;
            font-size: 24px; font-weight: 900;
            color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: floatUp 800ms ease-out forwards; z-index: 500;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.2); opacity: 0; } }

        /* Toast Notification */
        .toast-container { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 350px; }
        .toast {
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            color: white; padding: 12px 20px; border-radius: 12px;
            font-size: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out forwards;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Stats Row */
        .stats-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; }
        .stats-row:last-child { border-bottom: none; }

    </style>
</head>
<body>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Header -->
    <div class="top-bar">
        <div class="logo">@<span id="home-username">Loading...</span></div>
        <div class="balance-display">
            <div>üí∞ <span id="hatch-balance">0</span></div>
            <div>üíé <span id="points-balance">0</span></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        
        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen active">
            <div class="egg-card">
                <div class="egg-name" id="egg-name">Egg</div>
                <div class="egg-description" id="egg-description">Description</div>
                
                <div class="egg-container">
                    <div class="egg-glow"></div>
                    <img src="" class="egg-image" id="main-egg" alt="Egg">
                </div>

                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"><span id="progress-percentage">0%</span></div>
                </div>
                <div class="progress-text">
                    <span id="current-hp">0</span> / <span id="required-hp">1000</span> HP
                </div>
            </div>

            <div class="collection-box">
                <div class="collection-label">Farm Income</div>
                <div class="collection-amount">üí∞ <span id="collected-amount">0</span></div>
                <button class="collect-btn" id="collect-btn" onclick="collectIncome()">Collect</button>
                <div class="next-collection">Max capacity in: <span id="next-timer">8h 0m</span></div>
            </div>

            <div class="section-title" style="font-size: 14px; opacity:0.7; margin-bottom:10px; text-transform: uppercase;">Quick Actions</div>
            <div class="quick-actions">
                <button class="action-btn" onclick="switchTab('tasks')">üéØ<div class="action-label">Tasks</div></button>
                <button class="action-btn" onclick="claimDailyBonus()">üéÅ<div class="action-label">Bonus</div></button>
                <button class="action-btn" onclick="showReferral()">üë•<div class="action-label">Refer</div></button>
                <button class="action-btn" onclick="switchTab('hatch')">ü•ö<div class="action-label">Hatch</div></button>
            </div>
        </div>

        <!-- HATCH SCREEN -->
        <div id="hatch-screen" class="screen">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="font-size: 22px;">ü•ö Collection</h2>
                <div style="font-size:13px; opacity:0.7;">
                    Unlocked: <strong><span id="unlocked-count">0</span>/20</strong> &bull; 
                    Income: <strong style="color:#00d68f;">+<span id="total-income">0</span>/hr</strong>
                </div>
            </div>
            <div class="creatures-grid" id="creatures-grid"></div>
        </div>

        <!-- TASKS SCREEN -->
        <div id="tasks-screen" class="screen">
            <h2 style="margin-bottom:20px;">üìã Tasks</h2>
            <div class="task-card" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;">üî• Featured Survey</div>
                    <div style="font-size:12px; color:#00d68f;">+50 Points</div>
                </div>
                <button class="action-btn" style="width:auto; padding:10px 20px; border-radius:10px; font-size:14px;" onclick="showToast('Feature coming soon!')">START</button>
            </div>
            
            <div style="font-size:14px; margin:20px 0 10px; opacity:0.7;">Social Tasks</div>
            <div class="task-card" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;">üê¶ Follow Twitter</div>
                    <div style="font-size:12px; color:#00d68f;">+50 $HATCH</div>
                </div>
                <button class="action-btn" style="width:auto; padding:10px 20px; border-radius:10px; font-size:14px;" onclick="showToast('Link opening...')">DO IT</button>
            </div>
        </div>

        <!-- PROFILE SCREEN -->
        <div id="profile-screen" class="screen">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="width:80px; height:80px; background:rgba(255,255,255,0.2); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:40px;">üë§</div>
                <h2 id="profile-username">@username</h2>
                <div style="font-size:12px; opacity:0.6;">Member since: <span id="join-date">Dec 2024</span></div>
            </div>
            
            <div class="upgrade-section">
                <div class="stats-row"><span>üí∞ Balance:</span><span id="profile-hatch">0</span></div>
                <div class="stats-row"><span>üíé Points:</span><span id="profile-points">0</span></div>
                <div class="stats-row" style="border:none;"><span>ü•ö Creatures:</span><span id="profile-creatures">0/20</span></div>
            </div>
            
            <button class="collect-btn" style="background:#333; font-size:14px; padding:10px; margin-top:10px;" onclick="resetGame()">‚ö†Ô∏è Reset Progress</button>
        </div>

    </div>

    <!-- DETAIL OVERLAY -->
    <detail-screen id="creature-detail"> <!-- Fixed tag name -->
        <div class="detail-header">
            <button class="back-btn" onclick="closeCreatureDetail()">‚Üê</button>
            <span style="font-weight:bold; font-size:18px;" id="detail-creature-name">Creature</span>
            <div style="width:36px;"></div> <!-- spacer -->
        </div>
        <div class="detail-content">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="" class="hatch-creature-reveal" id="detail-creature-img" style="width:150px; height:150px; margin-bottom:15px;">
                <h2 id="detail-creature-title" style="margin-bottom:5px;">Name</h2>
                <div id="detail-creature-level" style="opacity:0.7; font-size:14px;">Level 1/5</div>
            </div>
            
            <div class="upgrade-section">
                <div class="stats-row"><span>Current Income:</span><span style="color:#00d68f;" id="detail-current-income">+0/hr</span></div>
                <div class="stats-row"><span>Total Produced:</span><span id="detail-total-earned">0</span></div>
            </div>

            <div class="upgrade-section">
                <div style="text-align:center; margin-bottom:10px; font-weight:bold;">‚¨ÜÔ∏è UPGRADE</div>
                <div class="stats-row"><span>Next Production:</span><span style="color:#00d68f;" id="detail-next-prod">+0/hr</span></div>
                <div style="text-align:center; margin:15px 0; font-size:14px; opacity:0.8;">Cost: <strong style="color:#fff;" id="detail-upgrade-cost">0</strong></div>
                <button class="upgrade-btn" id="upgrade-btn" onclick="upgradeCreature()">UPGRADE NOW</button>
            </div>
        </div>
    </detail-screen> <!-- Fixed closing tag -->

    <!-- HATCH ANIMATION OVERLAY -->
    <div class="hatch-overlay" id="hatch-overlay">
        <h1 style="font-size:28px; margin-bottom:10px; color:#ffd700;">üéâ HATCHED! üéâ</h1>
        <img src="" class="hatch-creature-reveal" id="hatch-creature-img">
        <div style="font-size:20px; margin-bottom:5px;" id="hatch-stat-name">Name</div>
        <div style="color:#00d68f; font-weight:bold; margin-bottom:20px;" id="hatch-stat-income">+0/hr</div>
        <button class="collect-btn" onclick="finishHatching()">AWESOME!</button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('home')">üè†<span class="nav-label">Home</span></button>
        <button class="nav-btn" onclick="switchTab('hatch')">ü•ö<span class="nav-label">Hatch</span></button>
        <button class="nav-btn" onclick="switchTab('tasks')">üìã<span class="nav-label">Tasks</span></button>
        <button class="nav-btn" onclick="switchTab('profile')">üë§<span class="nav-label">Me</span></button>
    </div>

    <script>
        // ==========================================
        // CONFIG & DATA
        // ==========================================
        const BOT_API = "https://telegrambot-or4r.onrender.com";
        const API_SECRET = "383c5336-101c-4374-9cf9-44dd291db44c";
        
        // Simulate Telegram User ID for local testing
        let userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id?.toString();
        if (!userId) userId = "local_user_" + Math.random().toString(36).substr(2, 9);

        const CREATURES_CONFIG = {
            1:  { levels: [{ inc: 30, cost: 1000 }, { inc: 50, cost: 2500 }, { inc: 100, cost: 6000 }, { inc: 160, cost: 10000 }, { inc: 250, cost: null }] },
            2:  { levels: [{ inc: 40, cost: 2000 }, { inc: 70, cost: 5000 }, { inc: 150, cost: 13000 }, { inc: 300, cost: 24000 }, { inc: 700, cost: null }] },
            3:  { levels: [{ inc: 60, cost: 5000 }, { inc: 160, cost: 12000 }, { inc: 330, cost: 28000 }, { inc: 900, cost: 50000 }, { inc: 1500, cost: null }] },
            4:  { levels: [{ inc: 90, cost: 7000 }, { inc: 180, cost: 15000 }, { inc: 320, cost: 35000 }, { inc: 600, cost: 70000 }, { inc: 1200, cost: null }] },
            5:  { levels: [{ inc: 130, cost: 12000 }, { inc: 250, cost: 28000 }, { inc: 500, cost: 60000 }, { inc: 900, cost: 120000 }, { inc: 1800, cost: null }] },
            6:  { levels: [{ inc: 180, cost: 18000 }, { inc: 360, cost: 40000 }, { inc: 700, cost: 90000 }, { inc: 1400, cost: 180000 }, { inc: 2800, cost: null }] },
            7:  { levels: [{ inc: 250, cost: 26000 }, { inc: 500, cost: 60000 }, { inc: 1000, cost: 120000 }, { inc: 2000, cost: 240000 }, { inc: 4000, cost: null }] },
            8:  { levels: [{ inc: 350, cost: 40000 }, { inc: 700, cost: 90000 }, { inc: 1500, cost: 180000 }, { inc: 3000, cost: 360000 }, { inc: 6000, cost: null }] },
            9:  { levels: [{ inc: 500, cost: 60000 }, { inc: 1000, cost: 140000 }, { inc: 2000, cost: 280000 }, { inc: 4000, cost: 560000 }, { inc: 8000, cost: null }] },
            10: { levels: [{ inc: 700, cost: 90000 }, { inc: 1400, cost: 220000 }, { inc: 2800, cost: 440000 }, { inc: 5600, cost: 880000 }, { inc: 11200, cost: null }] },
            11: { levels: [{ inc: 1000, cost: 140000 }, { inc: 2000, cost: 300000 }, { inc: 4000, cost: 600000 }, { inc: 8000, cost: 1200000 }, { inc: 16000, cost: null }] },
            12: { levels: [{ inc: 1500, cost: 220000 }, { inc: 3000, cost: 450000 }, { inc: 6000, cost: 900000 }, { inc: 12000, cost: 1800000 }, { inc: 24000, cost: null }] },
            13: { levels: [{ inc: 2200, cost: 350000 }, { inc: 4400, cost: 700000 }, { inc: 8800, cost: 1400000 }, { inc: 17600, cost: 2800000 }, { inc: 35200, cost: null }] },
            14: { levels: [{ inc: 3200, cost: 550000 }, { inc: 6400, cost: 1100000 }, { inc: 12800, cost: 2200000 }, { inc: 25600, cost: 4400000 }, { inc: 51200, cost: null }] },
            15: { levels: [{ inc: 4500, cost: 850000 }, { inc: 9000, cost: 1700000 }, { inc: 18000, cost: 3400000 }, { inc: 36000, cost: 6800000 }, { inc: 72000, cost: null }] },
            16: { levels: [{ inc: 6500, cost: 1300000 }, { inc: 13000, cost: 2600000 }, { inc: 26000, cost: 5200000 }, { inc: 52000, cost: 10400000 }, { inc: 104000, cost: null }] },
            17: { levels: [{ inc: 9000, cost: 2000000 }, { inc: 18000, cost: 4000000 }, { inc: 36000, cost: 8000000 }, { inc: 72000, cost: 16000000 }, { inc: 144000, cost: null }] },
            18: { levels: [{ inc: 13000, cost: 3000000 }, { inc: 26000, cost: 6000000 }, { inc: 52000, cost: 12000000 }, { inc: 104000, cost: 24000000 }, { inc: 208000, cost: null }] },
            19: { levels: [{ inc: 18000, cost: 4500000 }, { inc: 36000, cost: 9000000 }, { inc: 72000, cost: 18000000 }, { inc: 144000, cost: 36000000 }, { inc: 288000, cost: null }] },
            20: { levels: [{ inc: 25000, cost: 6500000 }, { inc: 50000, cost: 13000000 }, { inc: 100000, cost: 26000000 }, { inc: 200000, cost: 52000000 }, { inc: 400000, cost: null }] }
        };

        const allEggs = [
            { id: 1, name: 'Chick', eggImg: 'assets/eggs/egg_chick.png', creatureImg: 'assets/creatures/creature_chick.png', hp: 1000, desc: 'Soft warmth seeps through the fragile shell.' },
            { id: 2, name: 'Turtle', eggImg: 'assets/eggs/egg_turtle.png', creatureImg: 'assets/creatures/creature_turtle.png', hp: 2500, desc: 'Heavy and calm, built to endure time.' },
            { id: 3, name: 'Lizard', eggImg: 'assets/eggs/egg_lizard.png', creatureImg: 'assets/creatures/creature_lizard.png', hp: 5000, desc: 'A faint pulse hints at swift movement inside.' },
            { id: 4, name: 'Snake', eggImg: 'assets/eggs/egg_snake.png', creatureImg: 'assets/creatures/creature_snake.png', hp: 7500, desc: 'Cold and silent, yet watching.' },
            { id: 5, name: 'Eagle', eggImg: 'assets/eggs/egg_eagle.png', creatureImg: 'assets/creatures/creature_eagle.png', hp: 10000, desc: 'Light as air, humming with skybound energy.' },
            { id: 6, name: 'Dino', eggImg: 'assets/eggs/egg_dino.png', creatureImg: 'assets/creatures/creature_dino.png', hp: 15000, desc: 'Ancient power sleeps beneath its surface.' },
            { id: 7, name: 'Dragon', eggImg: 'assets/eggs/egg_dragon.png', creatureImg: 'assets/creatures/creature_dragon.png', hp: 20000, desc: 'Intense heat radiates from within.' },
            { id: 8, name: 'Unicorn', eggImg: 'assets/eggs/egg_unicorn.png', creatureImg: 'assets/creatures/creature_unicorn.png', hp: 30000, desc: 'A gentle glow of pure magic surrounds it.' },
            { id: 9, name: 'Phoenix', eggImg: 'assets/eggs/egg_phoenix.png', creatureImg: 'assets/creatures/creature_phoenix.png', hp: 40000, desc: 'Warmth rises and falls like a heartbeat.' },
            { id: 10, name: 'Griffin', eggImg: 'assets/eggs/egg_griffin.png', creatureImg: 'assets/creatures/creature_griffin.png', hp: 55000, desc: 'Strength and pride rest within.' },
            { id: 11, name: 'Pegasus', eggImg: 'assets/eggs/egg_pegasus.png', creatureImg: 'assets/creatures/creature_pegasus.png', hp: 75000, desc: 'It feels lighter than it should.' },
            { id: 12, name: 'Golem', eggImg: 'assets/eggs/egg_golem.png', creatureImg: 'assets/creatures/creature_golem.png', hp: 100000, desc: 'Solid and unmoving, yet alive.' },
            { id: 13, name: 'Fairy', eggImg: 'assets/eggs/egg_fairy.png', creatureImg: 'assets/creatures/creature_fairy.png', hp: 150000, desc: 'A soft hum fills the air around it.' },
            { id: 14, name: 'Hydra', eggImg: 'assets/eggs/egg_hydra.png', creatureImg: 'assets/creatures/creature_hydra.png', hp: 200000, desc: 'Danger lingers beneath its shell.' },
            { id: 15, name: 'Cerberus', eggImg: 'assets/eggs/egg_cerberus.png', creatureImg: 'assets/creatures/creature_cerberus.png', hp: 300000, desc: 'Dark energy coils within.' },
            { id: 16, name: 'Kraken', eggImg: 'assets/eggs/egg_kraken.png', creatureImg: 'assets/creatures/creature_kraken.png', hp: 500000, desc: 'It vibrates with deep ocean force.' },
            { id: 17, name: 'Minotaur', eggImg: 'assets/eggs/egg_minotaur.png', creatureImg: 'assets/creatures/creature_minotaur.png', hp: 750000, desc: 'Raw power presses against the shell.' },
            { id: 18, name: 'Sphinx', eggImg: 'assets/eggs/egg_sphinx.png', creatureImg: 'assets/creatures/creature_sphinx.png', hp: 1000000, desc: 'Ancient wisdom watches silently.' },
            { id: 19, name: 'Chimera', eggImg: 'assets/eggs/egg_chimera.png', creatureImg: 'assets/creatures/creature_chimera.png', hp: 1500000, desc: 'Chaos stirs in unpredictable patterns.' },
            { id: 20, name: 'Elemental', eggImg: 'assets/eggs/egg_elemental.png', creatureImg: 'assets/creatures/creature_elemental.png', hp: 2000000, desc: 'Conflicting forces remain perfectly balanced.' }
        ];

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let state = {
            username: 'Player',
            balance: 0,
            points: 0,
            currentEggIndex: 0,
            currentEggHP: 0,
            creatures: {}, // { id: { level: 1, earned: 0 } }
            lastCollectionTime: Date.now(), // Timestamp for 8h timer
            lastDailyClaim: 0,
            lastSaveTime: Date.now()
        };

        let pendingTokens = 0;

        function loadState() {
            const saved = localStorage.getItem(`eggGame_v4_${userId}`);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state.username = parsed.username || state.username;
                    state.balance = Number(parsed.balance) || 0;
                    state.points = Number(parsed.points) || 0;
                    state.currentEggIndex = Number(parsed.currentEggIndex) || 0;
                    state.currentEggHP = Number(parsed.currentEggHP) || 0;
                    state.creatures = parsed.creatures || {};
                    
                    // CRITICAL: Handle timestamps correctly for offline progress
                    state.lastCollectionTime = Number(parsed.lastCollectionTime) || Date.now();
                    state.lastDailyClaim = Number(parsed.lastDailyClaim) || 0;

                    if (state.currentEggIndex >= allEggs.length) state.currentEggIndex = allEggs.length - 1;

                    console.log("State loaded successfully");
                } catch (e) { 
                    console.error("Save file corrupted, resetting.", e); 
                }
            } else {
                // New User
                state.username = "Hero" + Math.floor(Math.random() * 9999);
                state.lastCollectionTime = Date.now();
                console.log("New user created");
            }
            updateUI();
        }

        function saveState() {
            try {
                state.lastSaveTime = Date.now();
                localStorage.setItem(`eggGame_v4_${userId}`, JSON.stringify(state));
            } catch (e) {
                console.error("Save failed (Quota exceeded?)", e);
            }
        }

        function resetGame() {
            if(confirm("Are you sure? This will delete all progress!")) {
                localStorage.removeItem(`eggGame_v4_${userId}`);
                location.reload();
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function initGame() {
            loadState();
            
            // 1 Second Game Loop
            setInterval(() => {
                updatePassiveIncome();
            }, 1000);

            // Auto-save backup every 15s
            setInterval(saveState, 15000);

            // Save immediately when user leaves tab/app
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveState();
                }
            });

            window.addEventListener('beforeunload', () => {
                saveState();
            });

            // Setup Image Fallbacks
            document.querySelectorAll('img').forEach(img => {
                img.onerror = function() {
                    this.src = `https://picsum.photos/seed/${this.alt || 'egg'}/200/200`;
                };
            });
        }

        // ==========================================
        // CORE GAMEPLAY
        // ==========================================
        
        function tapEgg(e) {
            const egg = allEggs[state.currentEggIndex];
            const tapValue = 10; 
            
            state.currentEggHP += tapValue;
            state.balance += tapValue;
            pendingTokens += tapValue;

            showFloatingText(`+${tapValue}`, e.clientX, e.clientY);
            
            updateUI();
            saveState();

            if (state.currentEggHP >= egg.hp) {
                hatchEgg();
            }
        }

        function hatchEgg() {
            const egg = allEggs[state.currentEggIndex];
            
            state.creatures[egg.id] = {
                level: 1,
                earned: 0
            };

            const overlay = document.getElementById('hatch-overlay');
            document.getElementById('hatch-creature-img').src = egg.creatureImg;
            document.getElementById('hatch-stat-name').textContent = egg.name;
            
            const baseInc = CREATURES_CONFIG[egg.id].levels[0].inc;
            document.getElementById('hatch-stat-income').textContent = `+${baseInc}/hr`;
            
            overlay.classList.add('active');
        }

        function finishHatching() {
            document.getElementById('hatch-overlay').classList.remove('active');
            state.currentEggIndex++;
            state.currentEggHP = 0;
            
            if (state.currentEggIndex >= allEggs.length) {
                showToast("üéâ All Creatures Hatched!");
                state.currentEggIndex = allEggs.length - 1;
            }
            
            saveState();
            updateUI();
            switchTab('hatch');
        }

        // ==========================================
        // OFFLINE PASSIVE INCOME (FIXED)
        // ==========================================
        function updatePassiveIncome() {
            const incomePerHour = calculateTotalIncome();
            const now = Date.now();
            const maxCap = incomePerHour * 8; 
            
            // 1. Calculate time difference
            // If lastCollectionTime is in the future (clock adjustment), use 0
            let elapsedMs = now - state.lastCollectionTime;
            if (elapsedMs < 0) elapsedMs = 0;

            // 2. Calculate earned amount based on real time elapsed
            let earned = Math.floor((elapsedMs / (1000 * 60 * 60)) * incomePerHour);
            
            // 3. Cap at max
            let displayAmount = Math.min(earned, maxCap);
            if (incomePerHour === 0) displayAmount = 0;

            // 4. Update UI
            document.getElementById('collected-amount').textContent = displayAmount.toLocaleString();
            
            // 5. Update Timer Text
            // If earned is already capped, timer is 0. Otherwise, show remaining time to cap.
            let remainingMs = (8 * 60 * 60 * 1000) - elapsedMs;
            if (remainingMs < 0) remainingMs = 0;
            
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const mins = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('next-timer').textContent = (remainingMs > 0) ? `${hours}h ${mins}m` : "FULL";

            const btn = document.getElementById('collect-btn');
            btn.disabled = displayAmount <= 0;
        }

        function collectIncome() {
            const incomePerHour = calculateTotalIncome();
            const now = Date.now();
            
            // Recalculate exactly what is available right now
            let elapsedMs = now - state.lastCollectionTime;
            if (elapsedMs < 0) elapsedMs = 0;
            
            let earned = Math.floor((elapsedMs / (1000 * 60 * 60)) * incomePerHour);
            let maxCap = incomePerHour * 8;
            let finalAmount = Math.min(earned, maxCap);

            if (finalAmount > 0) {
                state.balance += finalAmount;
                pendingTokens += finalAmount;
                state.lastCollectionTime = now; // Reset timer to NOW
                
                updateUI();
                saveState();
                showToast(`Collected ${finalAmount.toLocaleString()} $HATCH`);
                
                syncToBackend(); 
            }
        }

        // ==========================================
        // CREATURES & UPGRADES
        // ==========================================
        function calculateTotalIncome() {
            let total = 0;
            for (let id in state.creatures) {
                const c = state.creatures[id];
                const config = CREATURES_CONFIG[id];
                if (config && config.levels[c.level - 1]) {
                    total += config.levels[c.level - 1].inc;
                }
            }
            return total;
        }

        function openCreatureDetail(id) {
            const overlay = document.getElementById('creature-detail');
            const egg = allEggs.find(e => e.id === id);
            const myCreature = state.creatures[id];
            const config = CREATURES_CONFIG[id];

            if (!egg || !myCreature || !config) return;

            const currentLvlIdx = myCreature.level - 1;
            const currentStats = config.levels[currentLvlIdx];
            const nextStats = config.levels[currentLvlIdx + 1];

            document.getElementById('detail-creature-img').src = egg.creatureImg;
            document.getElementById('detail-creature-name').textContent = egg.name;
            document.getElementById('detail-creature-title').textContent = egg.name;
            document.getElementById('detail-creature-level').textContent = `Level ${myCreature.level}/5`;
            
            document.getElementById('detail-current-income').textContent = `+${currentStats.inc}/hr`;
            document.getElementById('detail-total-earned').textContent = myCreature.earned.toLocaleString();

            const btn = document.getElementById('upgrade-btn');
            
            if (nextStats) {
                document.getElementById('detail-next-prod').textContent = `+${nextStats.inc}/hr`;
                document.getElementById('detail-upgrade-cost').textContent = `${nextStats.cost.toLocaleString()} $HATCH`;
                btn.disabled = state.balance < nextStats.cost;
                btn.onclick = () => upgradeCreature(id);
            } else {
                document.getElementById('detail-next-prod').textContent = "MAX LEVEL";
                document.getElementById('detail-upgrade-cost').textContent = "‚Äî";
                btn.disabled = true;
                btn.textContent = "MAX LEVEL";
            }

            overlay.classList.add('active');
        }

        function upgradeCreature(id) {
            const myCreature = state.creatures[id];
            const config = CREATURES_CONFIG[id];
            const currentLvlIdx = myCreature.level - 1;
            const nextStats = config.levels[currentLvlIdx + 1];

            if (!nextStats) return;
            if (state.balance < nextStats.cost) {
                showToast("Not enough funds!", "error");
                return;
            }

            state.balance -= nextStats.cost;
            pendingTokens -= nextStats.cost;
            myCreature.level++;
            
            saveState();
            updateUI();
            openCreatureDetail(id); 
            showToast("Upgrade Successful!");
        }

        function renderCreaturesGrid() {
            const grid = document.getElementById('creatures-grid');
            grid.innerHTML = '';

            allEggs.forEach((egg, idx) => {
                const card = document.createElement('div');
                
                if (state.creatures[egg.id]) {
                    const lvl = state.creatures[egg.id].level;
                    const inc = CREATURES_CONFIG[egg.id].levels[lvl-1].inc;
                    card.className = 'creature-card';
                    card.innerHTML = `
                        <img src="${egg.creatureImg}" class="creature-image">
                        <div class="c-name">${egg.name}</div>
                        <div class="c-level">Lvl ${lvl}</div>
                        <div class="c-income">+${inc}/hr</div>
                    `;
                    card.onclick = () => openCreatureDetail(egg.id);
                } else if (idx === state.currentEggIndex) {
                    card.className = 'creature-card locked';
                    card.innerHTML = `
                        <img src="${egg.eggImg}" class="creature-image">
                        <div class="c-name">${egg.name} Egg</div>
                        <div class="c-level" style="color:#ffd700;">In Progress</div>
                        <div style="font-size:11px; margin-top:4px;">${(state.currentEggHP||0).toLocaleString()}/${egg.hp.toLocaleString()}</div>
                    `;
                } else {
                    card.className = 'creature-card locked';
                    card.innerHTML = `
                        <img src="${egg.eggImg}" class="creature-image">
                        <div class="c-name">???</div>
                        <div class="c-level">Locked</div>
                        <div style="font-size:11px; margin-top:4px;">HP ${egg.hp.toLocaleString()}</div>
                    `;
                }
                grid.appendChild(card);
            });

            document.getElementById('unlocked-count').textContent = Object.keys(state.creatures).length;
            document.getElementById('total-income').textContent = calculateTotalIncome().toLocaleString();
        }

        // ==========================================
        // UI UPDATES & UTILS
        // ==========================================
        function updateUI() {
            const currentEgg = allEggs[state.currentEggIndex];
            
            // Home
            document.getElementById('home-username').textContent = state.username;
            document.getElementById('hatch-balance').textContent = state.balance.toLocaleString();
            document.getElementById('points-balance').textContent = state.points.toLocaleString();
            
            document.getElementById('egg-name').textContent = currentEgg.name + ' Egg';
            document.getElementById('egg-description').textContent = currentEgg.desc;
            document.getElementById('main-egg').src = currentEgg.eggImg;

            // Progress
            const pct = Math.min((state.currentEggHP / currentEgg.hp) * 100, 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('progress-percentage').textContent = `${Math.floor(pct)}%`;
            document.getElementById('current-hp').textContent = state.currentEggHP.toLocaleString();
            document.getElementById('required-hp').textContent = currentEgg.hp.toLocaleString();

            // Profile
            document.getElementById('profile-username').textContent = '@' + state.username;
            document.getElementById('profile-hatch').textContent = state.balance.toLocaleString();
            document.getElementById('profile-points').textContent = state.points.toLocaleString();
            document.getElementById('profile-creatures').textContent = `${Object.keys(state.creatures).length}/20`;

            if (document.getElementById('hatch-screen').classList.contains('active')) {
                renderCreaturesGrid();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tabName}-screen`).classList.add('active');
            
            const navMap = { 'home':0, 'hatch':1, 'tasks':2, 'profile':3 };
            const navBtns = document.querySelectorAll('.nav-btn');
            if (navBtns[navMap[tabName]]) navBtns[navMap[tabName]].classList.add('active');

            if (tabName === 'hatch') renderCreaturesGrid();
        }

        function closeCreatureDetail() {
            document.getElementById('creature-detail').classList.remove('active');
            updateUI();
        }

        function showFloatingText(text, x, y) {
            const el = document.createElement('div');
            el.className = 'float-text';
            el.textContent = text;
            el.style.left = (x - 20) + 'px'; 
            el.style.top = (y - 20) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if(type==='error') toast.style.border = '1px solid #ff4444';
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        function claimDailyBonus() {
            const now = Date.now();
            const lastClaim = state.lastDailyClaim || 0;
            const cooldown = 24 * 60 * 60 * 1000;

            if (now - lastClaim > cooldown) {
                state.points += 50;
                state.balance += 500;
                state.lastDailyClaim = now;
                saveState();
                updateUI();
                showToast("Daily Bonus Claimed! üíé +50pts");
            } else {
                const hoursLeft = Math.ceil((cooldown - (now - lastClaim)) / (1000*60*60));
                showToast(`Come back in ${hoursLeft} hours`, "error");
            }
        }
        
        function showReferral() {
            showToast("Referral link copied!");
        }

        function syncToBackend() {
            // Placeholder for backend logic
        }

        window.onload = initGame;
        
        document.getElementById('main-egg').addEventListener('pointerdown', (e) => {
            tapEgg(e);
        });

    </script>
</body>
</html>
